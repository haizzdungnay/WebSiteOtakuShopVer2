generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// CATEGORY
// ==========================================
model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@index([slug])
  @@map("categories")
}

// ==========================================
// PRODUCT
// ==========================================
model Product {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  shortDescription String?  @db.VarChar(600)
  description      String   @db.Text
  productCode      String?  @db.VarChar(64)
  price            Decimal  @db.Decimal(12, 2)
  comparePrice     Decimal? @db.Decimal(12, 2)
  stockQuantity    Int      @default(0)
  images           String[]
  isActive         Boolean  @default(true)
  featured         Boolean  @default(false)
  categoryId       String
  brandId          String?

  // Pre-order system
  preorderStatus PreorderStatus @default(NONE)
  preorderCutoff DateTime? // Ngày hết hạn đặt trước
  releaseDate    DateTime? // Ngày phát hành
  releaseCountry ReleaseCountry @default(JP)

  // MSRP (Manufacturer's Suggested Retail Price)
  msrpValue    Decimal? @db.Decimal(12, 2)
  msrpCurrency String?  @default("JPY") @db.Char(3)

  // Product details
  features  String? @db.Text // Đặc điểm sản phẩm
  condition String? @db.VarChar(100) // Tình trạng: New, Used, Like New, etc.

  // Review aggregates (cached for performance)
  reviewCount   Int     @default(0)
  averageRating Decimal @default(0) @db.Decimal(2, 1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  category   Category           @relation(fields: [categoryId], references: [id])
  brand      Brand?             @relation(fields: [brandId], references: [id])
  cartItems  CartItem[]
  orderItems OrderItem[]
  wishlists  Wishlist[]
  reviews    Review[]
  variants   ProductVariant[]
  characters ProductCharacter[]
  series     ProductSeries[]
  tags       ProductTag[]

  @@index([categoryId])
  @@index([brandId])
  @@index([slug])
  @@index([isActive])
  @@index([featured])
  @@index([averageRating])
  @@index([preorderStatus])
  @@index([releaseDate])
  @@map("products")
}

enum PreorderStatus {
  NONE // Hàng có sẵn
  PREORDER // Đặt trước (chưa phát hành)
  ORDER // Đặt hàng (phải order từ nhà sản xuất)
}

enum ReleaseCountry {
  JP // Japan
  CN // China
  US // United States
  VN // Vietnam
  OTHER // Other
}

// ==========================================
// USER
// ==========================================
model User {
  id                    String    @id @default(cuid())
  email                 String    @unique
  passwordHash          String
  fullName              String
  phone                 String?
  gender                Gender?   @default(OTHER)
  dateOfBirth           DateTime?
  avatar                String?
  role                  Role      @default(CUSTOMER)
  emailVerified         Boolean   @default(false)
  verificationToken     String?
  verificationExpires   DateTime?
  otpCode               String?   // 6-digit OTP code for verification
  otpExpires            DateTime? // OTP expiration time
  resetPasswordToken    String?
  resetPasswordExpires  DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  cartItems   CartItem[]
  orders      Order[]
  wishlists   Wishlist[]
  addresses   Address[]
  reviews     Review[]
  reviewVotes ReviewVote[]

  @@index([email])
  @@index([verificationToken])
  @@index([resetPasswordToken])
  @@index([otpCode])
  @@map("users")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Role {
  CUSTOMER
  ADMIN
}

// ==========================================
// ADDRESS
// ==========================================
model Address {
  id        String   @id @default(cuid())
  userId    String
  label     String   @default("Home")
  fullName  String
  phone     String
  address   String
  ward      String?
  district  String
  city      String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([userId])
  @@index([isDefault])
  @@map("addresses")
}

// ==========================================
// CART
// ==========================================
model CartItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  quantity  Int      @default(1)
  addedAt   DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@map("cart_items")
}

// ==========================================
// ORDER
// ==========================================
model Order {
  id          String  @id @default(cuid())
  orderNumber String  @unique
  userId      String?

  // Snapshot customer info
  customerName  String
  customerEmail String?
  customerPhone String

  // Snapshot shipping address
  shippingFullName String
  shippingPhone    String
  shippingAddress  String
  shippingWard     String?
  shippingDistrict String
  shippingCity     String

  totalAmount Decimal     @db.Decimal(10, 2)
  status      OrderStatus @default(PENDING)
  note        String?     @db.Text
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  user      User?    @relation(fields: [userId], references: [id])
  addressId String?
  address   Address? @relation(fields: [addressId], references: [id])
  couponId  String?
  coupon    Coupon?  @relation(fields: [couponId], references: [id])

  orderItems OrderItem[]
  payment    Payment?
  shipping   Shipping?
  reviews    Review[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
  @@index([userId, status]) // Composite index for user's orders by status
  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  SHIPPING
  DELIVERED
  COMPLETED
  CANCELLED
}

// ==========================================
// ORDER ITEM
// ==========================================
model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

// ==========================================
// ADMIN
// ==========================================
model Admin {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String
  fullName     String
  email        String   @unique
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  auditLogs AdminAuditLog[]

  @@index([username])
  @@index([email])
  @@map("admins")
}

// ==========================================
// ADMIN AUDIT LOG (Tracking admin actions)
// ==========================================
model AdminAuditLog {
  id          String   @id @default(cuid())
  adminId     String
  action      String   // e.g., "UPDATE_ORDER_STATUS", "DELETE_PRODUCT"
  entityType  String   // e.g., "Order", "Product", "User"
  entityId    String   // ID of the affected entity
  oldValue    Json?    // Previous state (for updates)
  newValue    Json?    // New state (for updates)
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

// ==========================================
// WISHLIST
// ==========================================
model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  productId String
  addedAt   DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("wishlists")
}

// ==========================================
// COUPON
// ==========================================
model Coupon {
  id          String     @id @default(cuid())
  code        String     @unique
  type        CouponType
  value       Decimal    @db.Decimal(10, 2)
  minOrder    Decimal?   @db.Decimal(10, 2)
  maxDiscount Decimal?   @db.Decimal(10, 2)
  validFrom   DateTime
  validTo     DateTime
  usageLimit  Int?
  usedCount   Int        @default(0)
  isActive    Boolean    @default(true)
  description String?    @db.Text
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  orders Order[]

  @@index([code])
  @@index([validFrom, validTo])
  @@index([isActive])
  @@map("coupons")
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
}

// ==========================================
// PAYMENT
// ==========================================
model Payment {
  id            String        @id @default(cuid())
  orderId       String        @unique
  amount        Decimal       @db.Decimal(10, 2)
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?
  metadata      Json?
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([transactionId])
  @@map("payments")
}

enum PaymentMethod {
  COD
  BANK_TRANSFER
  MOMO
  VNPAY
  ZALOPAY
  CREDIT_CARD
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

// ==========================================
// SHIPPING
// ==========================================
model Shipping {
  id            String         @id @default(cuid())
  orderId       String         @unique
  carrier       String
  trackingCode  String?
  fee           Decimal        @db.Decimal(10, 2)
  status        ShippingStatus @default(PREPARING)
  estimatedDate DateTime?
  shippedAt     DateTime?
  deliveredAt   DateTime?
  notes         String?        @db.Text
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([trackingCode])
  @@map("shippings")
}

enum ShippingStatus {
  PREPARING
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
  RETURNED
}

// ==========================================
// REVIEW (NEW!)
// ==========================================
model Review {
  id        String   @id @default(cuid())
  productId String
  userId    String
  orderId   String? // Liên kết với đơn hàng (verify đã mua)
  rating    Int // 1-5 sao
  title     String? // Tiêu đề review (optional)
  comment   String?  @db.Text
  images    String[] // Ảnh review từ khách

  // Moderation
  isVerified Boolean @default(false) // Badge "Đã mua hàng"
  isApproved Boolean @default(true) // Admin duyệt
  isPinned   Boolean @default(false) // Ghim review hay

  // Social
  helpfulCount   Int @default(0) // Cache số votes helpful
  unhelpfulCount Int @default(0) // Cache số votes unhelpful

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  order   Order?       @relation(fields: [orderId], references: [id])
  votes   ReviewVote[]

  @@index([productId])
  @@index([userId])
  @@index([orderId])
  @@index([rating])
  @@index([isApproved])
  @@index([isPinned])
  @@index([createdAt])
  @@index([productId, isApproved]) // Composite index for approved product reviews
  @@index([userId, productId]) // Check if user reviewed product
  @@map("reviews")
}

// ==========================================
// REVIEW VOTE (NEW!)
// ==========================================
model ReviewVote {
  id        String   @id @default(cuid())
  reviewId  String
  userId    String
  isHelpful Boolean // true = helpful, false = not helpful
  createdAt DateTime @default(now())

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId]) // 1 user chỉ vote 1 lần
  @@index([reviewId])
  @@index([userId])
  @@map("review_votes")
}

// ==========================================
// ANNOUNCEMENT (Thông báo nội bộ/công khai)
// ==========================================
model Announcement {
  id        String   @id @default(cuid())
  title     String
  summary   String   @db.Text
  content   String?  @db.Text
  imageUrl  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([createdAt])
  @@map("announcements")
}

// ==========================================
// BRAND (Thương hiệu sản xuất figure)
// ==========================================
model Brand {
  id   String @id @default(cuid())
  name String @unique
  slug String @unique

  products Product[]

  @@index([slug])
  @@map("brands")
}

// ==========================================
// CHARACTER (Nhân vật anime/manga)
// ==========================================
model Character {
  id   String @id @default(cuid())
  name String @unique
  slug String @unique

  products ProductCharacter[]

  @@index([slug])
  @@map("characters")
}

// ==========================================
// SERIES (Bộ anime/manga/game)
// ==========================================
model Series {
  id   String @id @default(cuid())
  name String @unique
  slug String @unique

  products ProductSeries[]

  @@index([slug])
  @@map("series")
}

// ==========================================
// TAG (Tag sản phẩm)
// ==========================================
model Tag {
  id   String @id @default(cuid())
  name String @unique
  slug String @unique

  products ProductTag[]

  @@index([slug])
  @@map("tags")
}

// ==========================================
// PRODUCT - CHARACTER (Many-to-Many)
// ==========================================
model ProductCharacter {
  productId   String
  characterId String

  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@id([productId, characterId])
  @@map("product_characters")
}

// ==========================================
// PRODUCT - SERIES (Many-to-Many)
// ==========================================
model ProductSeries {
  productId String
  seriesId  String

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  series  Series  @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  @@id([productId, seriesId])
  @@map("product_series")
}

// ==========================================
// PRODUCT - TAG (Many-to-Many)
// ==========================================
model ProductTag {
  productId String
  tagId     String

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([productId, tagId])
  @@map("product_tags")
}

// ==========================================
// PRODUCT VARIANT (Biến thể sản phẩm)
// ==========================================
model ProductVariant {
  id           String    @id @default(cuid())
  productId    String
  sku          String    @unique
  variantName  String? // Tên biến thể (VD: "Limited Edition")
  edition      String? // Phiên bản (Standard, Limited, Exclusive)
  scale        String? // Tỉ lệ (1/7, 1/8, 1/4)
  material     String? // Chất liệu (PVC, ABS, Resin)
  heightMm     Int? // Chiều cao (mm)
  widthMm      Int? // Chiều rộng (mm)
  depthMm      Int? // Chiều sâu (mm)
  weightGrams  Int? // Cân nặng (gram)
  price        Decimal   @db.Decimal(12, 2)
  comparePrice Decimal?  @db.Decimal(12, 2)
  saleStartsAt DateTime?
  saleEndsAt   DateTime?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  product   Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventory Inventory[]

  @@index([productId, isActive])
  @@index([sku])
  @@index([saleStartsAt, saleEndsAt])
  @@map("product_variants")
}

// ==========================================
// WAREHOUSE (Kho hàng)
// ==========================================
model Warehouse {
  id       String  @id @default(cuid())
  code     String  @unique
  name     String
  address  String?
  city     String?
  isActive Boolean @default(true)

  inventory Inventory[]

  @@index([code])
  @@map("warehouses")
}

// ==========================================
// INVENTORY (Tồn kho theo kho)
// ==========================================
model Inventory {
  variantId   String
  warehouseId String
  qtyOnHand   Int    @default(0) // Số lượng hiện có
  qtyReserved Int    @default(0) // Số lượng đã đặt trước

  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  warehouse Warehouse      @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@id([variantId, warehouseId])
  @@map("inventory")
}
